# Lunar New Year events

# by Silverswee(e)per

namespace = LNY

# Currently, the following characters have access to the LNY:
# - Taoists
# - Shenists
# - Reformed Shenists - even if not "Chinese enough"
# - Chinese culture group Buddhists; this might potentially be expanded a bit in the future
# This choice should give the festival to most characters that realistically should be interested in it while not giving it to characters that have some other festival (e.g. Japonic Buddhists have the Hanami).

# The LNY can be celebrated Jan-Feb in the mod, and the actual LNY is assumed to take place February 1 (the sixty year cycle is rather more complicated to include).
# Festivities should take place in roughly the right order, but will be spaced out a bit, so they might not be on the right day.

### Initial setup 1-9

# Determine if zodiac and/or element matches
character_event = {
	id = LNY.1
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		# TODO: Clear various flags from any previous LNY celebration
		# Clear flags for any previous match
		clr_character_flag = lny_zodiac_match
		clr_character_flag = lny_element_match
		# Determine ROOT's zodiac/element
		set_this_chinese_year_zodiac_element_yin_yang_effect = yes
		# Determine the zodiac/element of the new year and the old year - done globally
		set_old_chinese_year_zodiac_element_yin_yang_effect = yes
		set_new_chinese_year_zodiac_element_yin_yang_effect = yes
		# Check if there's a match
		if = {
			limit = {
				lunar_new_year_is_this_zodiac_trigger = yes
			}
			set_character_flag = lny_zodiac_match
		}
		if = {
			limit = {
				lunar_new_year_is_this_element_trigger = yes
			}
			set_character_flag = lny_element_match
		}
		character_event = { id = LNY.2 } # Dragon dance
		random = {
			chance = 50
			character_event = { id = LNY.3 days = 1 } # Musicians
		}
		random = {
			chance = 50
			character_event = { id = LNY.4 days = 2 } # Acrobats
		}
		character_event = { id = LNY.5 days = 3 } # Fireworks
		random = {
			chance = 50
			character_event = { id = LNY.6 days = 4 } # Lion dance
		}
		character_event = { id = LNY.7 days = 5 } # Decorations
		random = {
			chance = 50
			character_event = { id = LNY.8 days = 6 } # Red envelopes
		}
		character_event = { id = LNY.9 days = 7 } # Food
		character_event = { id = LNY.10 days = 8 } # Invitations
	}
}

# Decide on dragon dance
character_event = {
	id = LNY.2
	desc = EVTDESC_LNY_2
	picture = GFX_evt_china_golden_age # TODO
	is_triggered_only = yes
	
	trigger = {
		has_character_modifier = lny_in_progress
	}
	
	option = {
		name = EVTOPTA_LNY_2 # What is the smallest dragon I can get away with?
		
		wealth = -5
		set_character_flag = small_dragon_dance
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = charitable
			}
			modifier = {
				factor = 0.1
				NOT = {
					trait = greedy
				}
			}
			modifier = {
				factor = 0.1
				trait = proud
			}
		}
	}
	option = {
		name = EVTOPTB_LNY_2 # Give me one normal-sized dragon!
		
		wealth = -10
		set_character_flag = normal_dragon_dance
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.1
				trait = greedy
			}
			modifier = {
				factor = 0.1
				trait = proud
			}
			modifier = {
				factor = 0.1
				trait = ambitious
			}
		}
	}
	option = {
		name = EVTOPTC_LNY_2 # Two dragons!
		
		wealth = -25
		set_character_flag = two_dragon_dance
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = greedy
			}
		}
	}
	option = {
		trigger = {
			OR = {
				tier = king
				tier = emperor
			}
			is_feudal = yes
		}
		name = EVTOPTD_LNY_2 # Give me the full nine dragons!
		
		wealth = -200
		set_character_flag = nine_dragon_dance
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = greedy
			}
			modifier = {
				factor = 10
				trait = ambitious
			}
			modifier = {
				factor = 10
				trait = proud
			}
			modifier = {
				factor = 10
				trait = is_chinese_emperor_trigger = yes
			}
		}
	}
}

# Musicians
character_event = {
	id = LNY.3
	desc = EVTDESC_LNY_3
	picture = GFX_evt_china_golden_age # TODO
	is_triggered_only = yes
	
	trigger = {
		has_character_modifier = lny_in_progress
	}
	
	option = {
		name = EVTOPTA_LNY_3 # Musicians would make the celebration better
		
		wealth = -15
		set_character_flag = musicians_hired
		
		ai_chance = {
			factor = 75
			modifier = {
				factor = 0.1
				trait = greedy
			}
		}
	}
	option = {
		name = EVTOPTB_LNY_3 # Musicians would make the celebration better
		
		set_character_flag = no_musicians_hired
		
		ai_chance = {
			factor = 25
			modifier = {
				factor = 0.1
				trait = charitable
			}
		}
	}
}

# Acrobats
character_event = {
	id = LNY.4
	desc = EVTDESC_LNY_4
	picture = GFX_evt_china_golden_age # TODO
	is_triggered_only = yes
	
	trigger = {
		has_character_modifier = lny_in_progress
	}
	
	option = {
		name = EVTOPTA_LNY_4 # Acrobats would make the celebration better
		
		wealth = -15
		set_character_flag = acrobats_hired
		
		ai_chance = {
			factor = 75
			modifier = {
				factor = 0.1
				trait = greedy
			}
		}
	}
	option = {
		name = EVTOPTB_LNY_4 # Acrobats would make the celebration better
		
		set_character_flag = no_acrobats_hired
		
		ai_chance = {
			factor = 25
			modifier = {
				factor = 0.1
				trait = charitable
			}
		}
	}
}

# Fireworks
character_event = {
	id = LNY.5
	desc = EVTDESC_LNY_5
	picture = GFX_evt_china_golden_age # TODO
	is_triggered_only = yes
	
	trigger = {
		has_character_modifier = lny_in_progress
	}
	
	option = {
		name = EVTOPTA_LNY_5 # Get as few as possible
		
		wealth = -5
		set_character_flag = small_fireworks
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = charitable
			}
			modifier = {
				factor = 0.1
				NOT = {
					trait = greedy
				}
			}
			modifier = {
				factor = 0.1
				trait = proud
			}
		}
	}
	option = {
		name = EVTOPTB_LNY_5 # Get a decent amount
		
		wealth = -10
		set_character_flag = normal_fireworks
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.1
				trait = greedy
			}
			modifier = {
				factor = 0.1
				trait = proud
			}
			modifier = {
				factor = 0.1
				trait = ambitious
			}
		}
	}
	option = {
		name = EVTOPTC_LNY_5 # Get more than enough
		
		wealth = -25
		set_character_flag = large_fireworks
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = greedy
			}
		}
	}
	option = {
		name = EVTOPTD_LNY_5 # Get a LOT more than expected
		
		wealth = -100
		set_character_flag = massive_fireworks
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = greedy
			}
			modifier = {
				factor = 10
				trait = ambitious
			}
			modifier = {
				factor = 10
				trait = proud
			}
			modifier = {
				factor = 10
				trait = is_chinese_emperor_trigger = yes
			}
		}
	}
}

# Lion dance
character_event = {
	id = LNY.6
	desc = EVTDESC_LNY_6
	picture = GFX_evt_china_golden_age # TODO
	is_triggered_only = yes
	
	trigger = {
		has_character_modifier = lny_in_progress
	}
	
	option = {
		name = EVTOPTA_LNY_6 # Sure, let's have one of those!
		
		wealth = -15
		set_character_flag = lion_dance
		
		ai_chance = {
			factor = 75
			modifier = {
				factor = 0.1
				trait = greedy
			}
		}
	}
	option = {
		name = EVTOPTB_LNY_6 # It's not worth it...
		
		set_character_flag = no_lion_dance
		
		ai_chance = {
			factor = 25
			modifier = {
				factor = 0.1
				trait = charitable
			}
		}
	}
}

# Decorations
character_event = {
	id = LNY.7
	desc = EVTDESC_LNY_7
	picture = GFX_evt_china_golden_age # TODO
	is_triggered_only = yes
	
	trigger = {
		has_character_modifier = lny_in_progress
	}
	
	option = {
		name = EVTOPTA_LNY_7 # Don't bother
		
		set_character_flag = no_decorations
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = charitable
			}
			modifier = {
				factor = 0.1
				NOT = {
					trait = greedy
				}
			}
		}
	}
	option = {
		name = EVTOPTB_LNY_7 # Get a decent amount
		
		wealth = -15
		set_character_flag = normal_decorations
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.1
				trait = greedy
			}
		}
	}
	option = {
		name = EVTOPTC_LNY_7 # Get more than expected
		
		wealth = -50
		set_character_flag = extravagant_decorations
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = greedy
			}
		}
	}
}

# Red envelopes
character_event = {
	id = LNY.8
	desc = EVTDESC_LNY_8
	picture = GFX_evt_china_golden_age # TODO
	is_triggered_only = yes
	
	trigger = {
		has_character_modifier = lny_in_progress
	}
	
	option = {
		name = EVTOPTA_LNY_8 # Sure, let's do that!
		
		wealth = -25
		set_character_flag = red_envelopes
		
		ai_chance = {
			factor = 75
			modifier = {
				factor = 0.1
				trait = greedy
			}
		}
	}
	option = {
		name = EVTOPTB_LNY_6 # It's not worth it...
		
		set_character_flag = no_red_envelopes
		
		ai_chance = {
			factor = 25
			modifier = {
				factor = 0.1
				trait = charitable
			}
		}
	}
}

# Food preparations - vanilla code
character_event = {
	id = LNY.9
	desc = EVTDESC_LNY_9
	picture = GFX_evt_feast
	border = GFX_event_normal_frame_diplomacy

	only_rulers = yes
	capable_only = yes
	prisoner = no
	war = no

	is_triggered_only = yes

	trigger = {
		has_character_modifier = lny_in_progress
		NOT = {
			has_character_flag = lavishly_food
		}
		NOT = {
			has_character_flag = medium_food
		}
		NOT = {
			has_character_flag = low_food
		}
	}

	option = {
		name = "EVTOPTA72003" #Spend lavishly on food
		gain_weight_small_effect = yes
		weight_trait_check_effect = yes
		trigger = { NOT = { trait = temperate } }
		ai_chance = {

			factor = 30

			modifier = {
				factor = 0.5
				trait = greedy
			}
			modifier = {
				factor = 3
				trait = gluttonous
			}
			modifier = {
				factor = 0.1
				trait = temperate
			}
			modifier = {
				factor = 2
				primary_title = { higher_tier_than = DUKE }
			}
		}
		set_character_flag = lavishly_food
		treasury = -20
		prestige = 10
	}
	option = {
		name = "EVTOPTB72003" #Spend medium on food
		ai_chance = {
			factor = 30

			modifier = {
				factor = 0.5
				NOT = { trait = greedy }
			}
			modifier = {
				factor = 2
				NOT = { trait = gluttonous }
			}
			modifier = {
				factor = 2
				primary_title = { tier = DUKE }
			}
		}
		set_character_flag = medium_food
		treasury = -10
	}
	option = {
		name = "EVTOPTC72003" #Spend low on food
		trigger = { NOT = { trait = gluttonous } }
		ai_chance = {
			factor = 30

			modifier = {
				factor = 2.5
				trait = greedy
			}
			modifier = {
				factor = 0.1
				trait = gluttonous
			}
			modifier = {
				factor = 2
				primary_title = { tier = COUNT }
			}
		}
		set_character_flag = low_food
		treasury = -5
		prestige = -5
	}
}

### Invitations 10-12

# Time to send out invitations
character_event = {
	id = LNY.10
	desc = EVTDESC_LNY_10
	picture = GFX_evt_garden
	border = GFX_event_normal_frame_diplomacy

	is_triggered_only = yes

	only_rulers = yes
	capable_only = yes
	prisoner = no
	war = no

	trigger = {
		has_character_modifier = lny_in_progress
		OR = {
			has_character_flag = lavishly_food
			has_character_flag = medium_food
			has_character_flag = low_food
		}
		NOT = {
			has_character_flag = sent_invitations
		}
	}
	
	option = {
		name = "EVTOPTA72010"
		set_character_flag = sent_invitations
		custom_tooltip = {
			text = EVTTOOLTIP1_RoI_1000
		}
		hidden_tooltip = {
			narrative_event = { id = japan.112 days = 20 }
			any_vassal = {
				limit = {
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
					NOT = { has_character_flag = do_not_disturb }
					NOT = { trait = incapable }
					NOT = { has_character_modifier = lny_in_progress }
					war = no
					is_adult = yes
				}
				letter_event = {
					id = LNY.11
					days = 2
					#tooltip = "EVTTOOLTIP72011"
				}
			}
		}
	}
}

# Vassal gets invitation
letter_event = {
	id = LNY.11
	desc = EVTDESC_LNY_11

	is_triggered_only = yes

	trigger = { NOT = { is_inaccessible_trigger = yes } }

	option = {
		name = EVTOPTA_LNY_11 # Travel to the LNY celebration
		ai_chance = {
			factor = 1
			modifier = {
				factor = 2
				opinion = { who = from value = -40 }
			}
			modifier  = {
				factor = 2
				opinion = { who = from value = -20 }
			}
		}
		set_character_flag = coming_to_lny
	}
	option = {
		name = EVTOPTB_LNY_11 # Refuse
		ai_chance = {
			factor = 1
			modifier  = {
				factor = 2
				NOT = { opinion = { who = from value = -60 } }
			}
			modifier  = {
				factor = 2
				NOT = { opinion = { who = from value = -80 } }
			}
		}
		FROM = {
			letter_event = {
				id = LNY.12
				days = 1
				random = 2
				tooltip = "EVTTOOLTIP72012"
			}
		}
	}
}

# Vassal refused invitation
letter_event = {
	id = LNY.12
	desc = EVTDESC_LNY_12

	is_triggered_only = yes

	option = {
		name = "EVTOPTA72012"
		opinion = {
			modifier = opinion_dislike
			who = FROM
			years = 10
		}
	}
}