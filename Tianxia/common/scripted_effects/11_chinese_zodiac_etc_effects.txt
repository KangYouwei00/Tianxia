set_chinese_year_effect = {
	set_variable = {
		which = chinese_year
		value = 0
	}
	# To avoid having to use the entire sixty year cycle, we'll assume that the Lunar New Year takes place February 1 every year
	if = {
		limit = {
			NOT = {
				month = 1
			}
		}
		export_to_variable = {
			which = chinese_year
			value = year
			who = ROOT
		}
		change_variable = {
			which = chinese_year
			value = -1
		}
	}
	else = {
		export_to_variable = {
			which = chinese_year
			value = year
			who = ROOT
		}
	}
	change_variable = {
		which = chinese_year
		value = 2637
	}
}

set_chinese_zodiac_effect = {
	# This assumes we've already used set_chinese_year_effect
	set_variable = {
		which = chinese_zodiac
		value = chinese_year
	}
	modulo_variable = {
		which = chinese_zodiac
		value = 12
	}
	# To avoid having to use the entire sixty year cycle, we'll assume that the Lunar New Year takes place February 1 every year
	if = {
		limit = {
			NOT = {
				month = 1
			}
		}
		if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 1 }
			}
			set_character_flag = chinese_zodiac_dog
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 2 }
			}
			set_character_flag = chinese_zodiac_rat
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 3 }
			}
			set_character_flag = chinese_zodiac_ox
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 4 }
			}
			set_character_flag = chinese_zodiac_tiger
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 5 }
			}
			set_character_flag = chinese_zodiac_rabbit
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 6 }
			}
			set_character_flag = chinese_zodiac_dragon
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 7 }
			}
			set_character_flag = chinese_zodiac_snake
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 8 }
			}
			set_character_flag = chinese_zodiac_horse
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 9 }
			}
			set_character_flag = chinese_zodiac_goat
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 10 }
			}
			set_character_flag = chinese_zodiac_monkey
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 11 }
			}
			set_character_flag = chinese_zodiac_rooster
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 0 }
			}
			set_character_flag = chinese_zodiac_dog
		}
	}
	else = {
		if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 1 }
			}
			set_character_flag = chinese_zodiac_rat
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 2 }
			}
			set_character_flag = chinese_zodiac_ox
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 3 }
			}
			set_character_flag = chinese_zodiac_tiger
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 4 }
			}
			set_character_flag = chinese_zodiac_rabbit
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 5 }
			}
			set_character_flag = chinese_zodiac_dragon
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 6 }
			}
			set_character_flag = chinese_zodiac_snake
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 7 }
			}
			set_character_flag = chinese_zodiac_horse
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 8 }
			}
			set_character_flag = chinese_zodiac_goat
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 9 }
			}
			set_character_flag = chinese_zodiac_monkey
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 10 }
			}
			set_character_flag = chinese_zodiac_rooster
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 11 }
			}
			set_character_flag = chinese_zodiac_dog
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_zodiac value = 0 }
			}
			set_character_flag = chinese_zodiac_pig
		}
	}
}

set_chinese_element_effect = {
	# This assumes we've already used set_chinese_year_effect
	set_variable = {
		which = chinese_element
		value = chinese_year
	}
	modulo_variable = {
		which = chinese_element
		value = 10
	}
	# To avoid having to use the entire sixty year cycle, we'll assume that the Lunar New Year takes place February 1 every year
	if = {
		limit = {
			NOT = {
				month = 1
			}
		}
		if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 1 }
			}
			set_character_flag = chinese_element_water
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 2 }
			}
			set_character_flag = chinese_element_wood
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 3 }
			}
			set_character_flag = chinese_element_wood
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 4 }
			}
			set_character_flag = chinese_element_fire
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 5 }
			}
			set_character_flag = chinese_element_fire
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 6 }
			}
			set_character_flag = chinese_element_earth
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 7 }
			}
			set_character_flag = chinese_element_earth
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 8 }
			}
			set_character_flag = chinese_element_metal
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 9 }
			}
			set_character_flag = chinese_element_metal
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 0 }
			}
			set_character_flag = chinese_element_water
		}
	}
	else = {
		if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 1 }
			}
			set_character_flag = chinese_element_wood
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 2 }
			}
			set_character_flag = chinese_element_wood
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 3 }
			}
			set_character_flag = chinese_element_fire
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 4 }
			}
			set_character_flag = chinese_element_fire
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 5 }
			}
			set_character_flag = chinese_element_earth
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 6 }
			}
			set_character_flag = chinese_element_earth
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 7 }
			}
			set_character_flag = chinese_element_metal
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 8 }
			}
			set_character_flag = chinese_element_metal
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 9 }
			}
			set_character_flag = chinese_element_water
		}
		else_if = {
			limit = {
				is_variable_equal = { variable = chinese_element value = 0 }
			}
			set_character_flag = chinese_element_water
		}
	}
}

set_yin_yang_effect = {
	# This assumes we've already used set_chinese_year_effect
	set_variable = {
		which = yin_yang
		value = chinese_year
	}
	modulo_variable = {
		which = yin_yang
		value = 2
	}
	if = {
		limit = {
			NOT = {
				month = 1
			}
		}
		if = {
			limit = {
				is_variable_equal = { variable = yin_yang value = 1 }
			}
			set_character_flag = yin
		}
		else = {
			set_character_flag = yang
		}
	}
	else = {
		if = {
			limit = {
				is_variable_equal = { variable = yin_yang value = 1 }
			}
			set_character_flag = yang
		}
		else = {
			set_character_flag = yin
		}
	}
}

set_chinese_year_zodiac_element_yin_yang_effect = {
	set_chinese_year_effect = yes
	set_chinese_zodiac_effect = yes
	set_chinese_element_effect = yes
	set_yin_yang_effect = yes
	
	# Update the global year, if necessary
	if = {
		limit = {
			OR = {
				NOT = {
					has_global_flag = chinese_year_updated # The first time set_chinese_year_zodiac_element_yin_yang_effect is used
				}
				# February is short, so it is best to have a margin
				AND = {
					month = 1
					NOT = {
						month = 3
					}
				}
				had_global_flag = { flag = chinese_year_updated days = 50 } # We haven't updated things recently
			}
		}
		clr_global_flag = chinese_year_updated
		set_global_flag = chinese_year_updated
		# Year
		set_variable = {
			which = global_chinese_year
			value = ROOT
		}
		clr_global_flag = chinese_zodiac_rat
		clr_global_flag = chinese_zodiac_ox
		clr_global_flag = chinese_zodiac_tiget
		clr_global_flag = chinese_zodiac_rabbit
		clr_global_flag = chinese_zodiac_dragon
		clr_global_flag = chinese_zodiac_snake
		clr_global_flag = chinese_zodiac_horse
		clr_global_flag = chinese_zodiac_goat
		clr_global_flag = chinese_zodiac_monkey
		clr_global_flag = chinese_zodiac_rooster
		clr_global_flag = chinese_zodiac_dog
		clr_global_flag = chinese_zodiac_pig
		# Zodiac
		if = {
			limit = {
				has_character_flag = chinese_zodiac_rat
			}
			set_global_flag = chinese_zodiac_rat
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_ox
			}
			set_global_flag = chinese_zodiac_ox
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_tiger
			}
			set_global_flag = chinese_zodiac_tiger
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_rabbit
			}
			set_global_flag = chinese_zodiac_rabbit
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_dragon
			}
			set_global_flag = chinese_zodiac_dragon
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_snake
			}
			set_global_flag = chinese_zodiac_snake
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_horse
			}
			set_global_flag = chinese_zodiac_horse
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_goat
			}
			set_character_flag = chinese_zodiac_goat
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_monkey
			}
			set_global_flag = chinese_zodiac_monkey
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_rooster
			}
			set_global_flag = chinese_zodiac_rooster
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_dog
			}
			set_global_flag = chinese_zodiac_dog
		}
		else_if = {
			limit = {
				has_character_flag = chinese_zodiac_pig
			}
			set_global_flag = chinese_zodiac_pig
		}
		# Element
		clr_global_flag = chinese_element_wood
		clr_global_flag = chinese_element_fire
		clr_global_flag = chinese_element_earth
		clr_global_flag = chinese_element_metal
		clr_global_flag = chinese_element_water
		if = {
			limit = {
				has_character_flag = chinese_element_wood
			}
			set_global_flag = chinese_element_wood
		}
		else_if = {
			limit = {
				has_character_flag = chinese_element_fire
			}
			set_global_flag = chinese_element_fire
		}
		else_if = {
			limit = {
				has_character_flag = chinese_element_earth
			}
			set_global_flag = chinese_element_earth
		}
		else_if = {
			limit = {
				has_character_flag = chinese_element_metal
			}
			set_global_flag = chinese_element_metal
		}
		else_if = {
			limit = {
				has_character_flag = chinese_element_water
			}
			set_global_flag = chinese_element_water
		}
		# Yin/Yang
		clr_global_flag = year_is_yang
		clr_global_flag = year_is_yin
		if = {
			limit = {
				has_character_flag = yang
			}
			set_global_flag = year_is_yang
		}
		else = {
			set_global_flag = year_is_yin
		}
	}
}

set_this_chinese_year_of_birth = {
	set_variable = {
		which = chinese_year_of_birth
		value = 0
	}
	# To avoid having to use the entire sixty year cycle, we'll assume that the Lunar New Year takes place February 1 every year
	if = {
		limit = {
			NOT = {
				month_of_birth = 2 # Unlike "month", "month_of_birth" has January as 1
			}
		}
		export_to_variable = {
			which = chinese_year_of_birth
			value = year
			who = ROOT
		}
		change_variable = {
			which = chinese_year
			value = -1
		}
	}
	else = {
		export_to_variable = {
			which = chinese_year_of_birth
			value = year
			who = ROOT
		}
	}
	change_variable = {
		which = chinese_year_of_birth
		value = 2637
	}
}

set_this_chinese_zodiac_effect = {
	# This assumes we've already used set_this_chinese_year_of_birth
	set_variable = {
		which = my_chinese_zodiac
		value = chinese_year_of_birth
	}
	modulo_variable = {
		which = my_chinese_zodiac
		value = 12
	}
	# We don't need to check the month, since chinese_year_of_birth already took care of it
	if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 1 }
		}
		set_character_flag = my_chinese_zodiac_rat
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 2 }
		}
		set_character_flag = my_chinese_zodiac_ox
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 3 }
		}
		set_character_flag = my_chinese_zodiac_tiger
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 4 }
		}
		set_character_flag = my_chinese_zodiac_rabbit
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 5 }
		}
		set_character_flag = my_chinese_zodiac_dragon
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 6 }
		}
		set_character_flag = my_chinese_zodiac_snake
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 7 }
		}
		set_character_flag = my_chinese_zodiac_horse
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 8 }
		}
		set_character_flag = my_chinese_zodiac_goat
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 9 }
		}
		set_character_flag = my_chinese_zodiac_monkey
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 10 }
		}
		set_character_flag = my_chinese_zodiac_rooster
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 11 }
		}
		set_character_flag = my_chinese_zodiac_dog
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_zodiac value = 0 }
		}
		set_character_flag = my_chinese_zodiac_pig
	}
}

set_this_chinese_element_effect = {
	# This assumes we've already used set_this_chinese_year_of_birth
	set_variable = {
		which = my_chinese_element
		value = chinese_year_of_birth
	}
	modulo_variable = {
		which = my_chinese_element
		value = 10
	}
	# We don't need to check the month, since chinese_year_of_birth already took care of it
	if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 1 }
		}
		set_character_flag = my_chinese_element_wood
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 2 }
		}
		set_character_flag = my_chinese_element_wood
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 3 }
		}
		set_character_flag = my_chinese_element_fire
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 4 }
		}
		set_character_flag = my_chinese_element_fire
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 5 }
		}
		set_character_flag = my_chinese_element_earth
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 6 }
		}
		set_character_flag = my_chinese_element_earth
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 7 }
		}
		set_character_flag = my_chinese_element_metal
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 8 }
		}
		set_character_flag = my_chinese_element_metal
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 9 }
		}
		set_character_flag = my_chinese_element_water
	}
	else_if = {
		limit = {
			is_variable_equal = { variable = my_chinese_element value = 0 }
		}
		set_character_flag = my_chinese_element_water
	}
}

set_this_yin_yang_effect = {
	# This assumes we've already used set_this_chinese_year_of_birth
	set_variable = {
		which = yin_yang
		value = chinese_year_of_birth
	}
	modulo_variable = {
		which = yin_yang
		value = 2
	}
	# We don't need to check the month, since chinese_year_of_birth already took care of it
	if = {
		limit = {
			is_variable_equal = { variable = yin_yang value = 1 }
		}
		set_character_flag = i_am_yang
	}
	else = {
		set_character_flag = i_am_yin
	}
}

set_this_chinese_year_zodiac_element_yin_yang_effect = {
	if = {
		limit = {
			has_character_flag = chinese_zodiac_element_yin_yang_set
		}
		# No need to do anything
	}
	else = {
		set_character_flag = chinese_zodiac_element_yin_yang_set
		set_this_chinese_year_of_birth = yes
		set_this_chinese_zodiac_effect = yes
		set_this_chinese_element_effect = yes
		set_this_yin_yang_effect = yes
	}
}