# Hwarang society decisions/powers

society_decisions = {
	request_to_rank_up_hwarang = {
		ai_check_interval = 12
		only_playable = yes
		is_in_society = yes

		hide_in_decisions_list = yes # This is shown in the Society View
		
		potential = {
			has_dlc = "Holy Fury"
			hidden_tooltip = {
				society_rank < 3
				days_in_society > 365
				OR = {
					AND = {
						ai = no
						society_rank == 1
					}
					society_can_rank_up = yes
				}
			}
			society_member_of = hwarang
		}
		
		allow = {
			OR = {
				AND = {
					society_rank == 1
					society_currency >= 750
					is_adult = yes
				}
				AND = {
					society_rank == 2
					society_currency >= 1000
				}
			}
		}
		
		effect = {
			society = { save_event_target_as = my_society }
			#Rank up cost
			if = {
				limit = { society_rank == 1 }
				change_society_currency = -750
			}
			if = {
				limit = { society_rank == 2 }
				change_society_currency = -1000
			}

			#Perform rank up
			hidden_tooltip = {
				save_event_target_as = rank_up_target
				set_character_flag = has_sent_request_to_rank_up
				character_event = { id = MNM.10002 days = 20 random = 10 } # sends hidden delayed event to self, which then sends request to Leader of the society
			}
		}
		
		ai_will_do = {
			factor = 1

			modifier = {
				factor = 0.5 #Slow down
			}
			modifier = {
				factor = 0.5
				trait = content
			}
			modifier = {
				factor = 2 
				trait = ambitious
			}
		}
	}
	
	# Demand society leadership
	
	# Cash out
	hwarang_cash_out = {
		ai_check_interval = 12
		is_in_society = yes
		potential = {
			society_member_of = hwarang
		}
		allow = {
			is_adult = yes
			is_inaccessible_or_incapable_trigger = no
		}
		effect = {
			custom_tooltip = {
				text = hwarang_cash_out_effect
				set_variable = {
					which = hwarang_cash_out
					value = 0
				}
				export_to_variable = {
					which = hwarang_cash_out
					value = society_currency
					who = ROOT
				}
				multiply_variable = {
					which = hwarang_cash_out
					value = 0.1
				}
				# TODO: Change piety and prestige by hwarang_cash_out (rounded to the nearest integer)
			}
			if = {
				limit = {
					ai = yes
				}
				set_character_flag = hwarang_ai_leave
			}
			else = {
				set_character_flag = hwarang_player_leave
			}
			leave_society = yes
		}
		ai_will_do = {
			factor = 0.1
			modifier = {
				factor = 0 # Only consider leaving if you are 20 + rank * 10 years old
				NOR = {
					AND = {
						society_rank == 1
						NOT = {
							age = 30
						}
					}
					AND = {
						society_rank == 2
						NOT = {
							age = 40
						}
					}
					AND = {
						society_rank == 3
						NOT = {
							age = 50
						}
					}
					AND = {
						society_rank == 4
						NOT = {
							age = 60
						}
					}
				}
			}
			modifier = {
				factor = 0.1 # Slow it down
				always = yes
			}
			modifier = {
				factor = 0.1 # The grandmaster is likely reluctant to leave
				is_society_grandmaster = yes
			}
			modifier = {
				factor = 10 # If you are 20 + rank * 20 years old, it's time to leave
				OR = {
					AND = {
						society_rank == 1
						age = 40
					}
					AND = {
						society_rank == 2
						age = 60
					}
					AND = {
						society_rank == 3
						age = 80
					}
					AND = {
						society_rank == 4
						age = 100
					}
				}
			}
		}
	}
	
	hwarang_lifestyle = {
		ai_check_interval = 12
		is_in_society = yes
		potential = {
			society_member_of = hwarang
			society_rank >= 3
		}
		allow = {
			is_adult = yes
			is_inaccessible_or_incapable_trigger = no
			has_society_currency_minor_trigger = yes
			# TODO: Block if we're choosing a lifestyle or if we've already got a relevant lifestyle
		}
		effect = {
			# TODO: Pick a lifestyle
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0
				lifestyle_traits = 1
			}
		}
	}
	
	hwarang_demand_leadership = {
		ai_check_interval = 12
		is_in_society = yes
		potential = {
			society_member_of = hwarang
			society_rank == 3
		}
		allow = {
			is_adult = yes
			is_inaccessible_or_incapable_trigger = no
			has_society_currency_major_trigger = yes
			any_society_member = {
				society_member_of = hwarang
				is_society_grandmaster = yes
				is_older_than = ROOT
				OR = {
					age_diff = {
						who = ROOT
						years >= 10
					}
					NOT = {
						any_society_member = {
							society_member_of = hwarang
							society_rank == 3
							is_older_than = ROOT
						}
					}
				}
			}
		}
		effect = {
			 # TODO: Give the grandmaster the choice between stepping aside or losing a lot of society currency, piety, and prestige
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.1
				trait = content
			}
			modifier = {
				factor = 0.1
				trait = humble
			}
			modifier = {
				factor = 10
				trait = ambitious
			}
			modifier = {
				factor = 10
				trait = proud
			}
		}
	}
}

targeted_decisions = {
	hwarang_personal_grooming = {
		ai_check_interval = 12
		is_in_society = yes
		filter = self
		ai_target_filter = self
		from_potential = {
			society_member_of = hwarang
			NOT = {
				trait = groomed
			}
		}
		
		potential = {
			character = FROM
		}
		
		allow = {
			is_inaccessible_or_incapable_trigger = no
			OR = {
				AND = {
					trait = uncouth
					has_society_currency_medium_trigger = yes
				}
				AND = {
					NOT = {
						trait = uncouth
					}
					has_society_currency_minor_trigger = yes
				}
			}
		}
		
		effect = {
			if = {
				limit = {
					trait = uncouth
				}
				detract_society_currency_medium_effect = yes
			}
			else = {
				detract_society_currency_minor_effect = yes
			}
			add_trait = groomed
		}
		
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.5
				trait = content
			}
			modifier = {
				factor = 0.5
				trait = humble
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = envious
			}
			modifier = {
				factor = 5
				trait = diligent
			}
			modifier = {
				factor = 0.1
				trait = slothful
			}
			modifier = {
				factor = 0.01
				trait = depressed
			}
		}
	}
	
	hwarang_seek_spiritual_guidance = {
		ai_check_interval = 12
		is_in_society = yes
		only_playable = yes
		ai_target_filter = society
		ai_target_filter = realm
		filter = society
		filter = realm
		from_potential = {
			society_member_of = hwarang
			NOT = {
				any_opinion_modifier_target = {
					OR = {
						AND = {
							culture = koreanic
							OR = {
								religion = taoist
								religion = buddhist
							}
						}
						religion = korean_pagan
						religion = korean_pagan_reformed
					}
					has_opinion_modifier = {
						who = FROM
						modifier = opinion_hwarang_offering_spiritual_guidance
					}
					reverse_has_opinion_modifier = {
						who = FROM
						modifier = opinion_hwarang_receiving_spiritual_guidance
					}
				}
			}
		}
		potential = {
			is_inaccessible_or_incapable_trigger = no
			OR = {
				AND = {
					culture = koreanic
					OR = {
						religion = taoist
						religion = buddhist
					}
				}
				religion = korean_pagan
				religion = korean_pagan_reformed
			}
			OR = {
				FROM = {
					NOT = {
						trait = zealous
					}
				}
				religion = FROM
			}
			OR = {
				AND = {
					is_landed = yes
					is_theocracy = yes
				}
				is_ascetic_trigger = yes
				learning = 15
				has_education_learning_trigger = yes
				has_lifestyle_learning_trigger = yes
				trait = zealous
			}
		}
		allow = {
			FROM = {
				is_adult = yes
				is_inaccessible_or_incapable_trigger = no
				has_society_currency_medium_trigger = yes
			}
		}
		effect = {
			FROM = {
				detract_society_currency_medium_effect = yes
			}
			# TODO: Ask the would-be teacher
		}
		ai_will_do = {
			factor = 0.1
			modifier = {
				factor = 0.1
				FROM = {
					NOT = {
						has_quest = quest_hwarang_spiritual_guidance
					}
				}
			}
			modifier = {
				factor = 0.1
				FROM = {
					NOT = {
						has_society_currency_major_trigger = yes
					}
				}
			}
			modifier = {
				factor = 0.1
				FROM = {
					trait = cynical
				}
			}
			modifier = {
				factor = 10
				FROM = {
					trait = zealous
				}
			}
			modifier = {
				factor = 0.5
				NOT = {
					religion = FROM
				}
			}
			modifier = {
				factor = 0.5
				NOR = {
					is_ascetic_trigger = yes
					AND = {
						is_landed = yes
						is_theocracy = yes
					}
					has_lifestyle_learning_trigger = yes
				}
			}
			modifier = {
				factor = 10
				OR = {
					has_ambition = obj_buddhist_stop_drinking
					has_ambition = obj_buddhist_reject_empty_pleasures
					has_ambition = obj_buddhist_abstain_sexual_excess
					has_ambition = obj_buddhist_reject_cruelty
					has_ambition = obj_buddhist_temperance_food
					has_ambition = obj_buddhist_reject_greed
					has_ambition = obj_buddhist_reject_envy
					has_ambition = obj_buddhist_reject_hate
					has_ambition = obj_buddhist_reject_pride
					has_ambition = obj_buddhist_defeat_fear
					has_ambition = obj_become_paragon_of_enlightenment
				}
			}
		}
	}
	
	hwarang_inspire_loyalty = {
		ai_check_interval = 12
		ai_target_filter = realm
		filter = realm
		from_potential = {
			society_member_of = hwarang
			society_rank >= 2
		}
		potential = {
			liege = {
				character = FROM
			}
			OR = {
				FROM = {
					ai = no
				}
				higher_tier_than = baron
				is_patrician = yes
			}
		}
		allow = {
			is_inaccessible_or_incapable_trigger = no
			is_adult = yes
			FROM = {
				is_inaccessible_or_incapable_trigger = no
				is_adult = yes
			}
			NOT = {
				has_opinion_modifier = {
					who = FROM
					modifier = opinion_hwarang_inspire_loyalty
				}
			}
			OR = {
				AND = {
					tier = count
					FROM = {
						has_society_currency_minor_trigger = yes
					}
				}
				AND = {
					tier = duke
					controls_religion = no
					FROM = {
						has_society_currency_medium_trigger = yes
					}
				}
				AND = {
					OR = {
						tier = king
						controls_religion = yes
					}
					FROM = {
						has_society_currency_major_trigger = yes
					}
				}
			}
		}
		effect = {
			if = {
				limit = {
					tier = count
				}
				FROM = {
					detract_society_currency_minor_effect = yes
				}
			}
			else_if = {
				limit = {
					tier = duke
					controls_religion = no
				}
				FROM = {
					detract_society_currency_medium_effect = yes
				}
			}
			else = {
				FROM = {
					detract_society_currency_major_effect = yes
				}
			}
			# TODO: Inform the vassal
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0 # Wasteful
				liege = {
					character = FROM
				}
				opinion = {
					who = FROM
					value = 25
				}
				in_faction = no
				OR = {
					is_voter = no
					has_position = loyalist
				}
			}
			modifier = {
				factor = 0.1
				opinion = {
					who = FROM
					value = 50
				}
			}
			modifier = {
				factor = 10
				liege = {
					character = FROM
				}
				in_faction = yes
			}
			modifier = {
				factor = 10
				liege = {
					character = FROM
				}
				is_voter = yes
				has_position = malcontent
			}
			modifier = {
				factor = 0.1
				FROM = {
					trait = trusting
				}
			}
			modifier = {
				factor = 0.1
				FROM = {
					is_dumb_trigger = yes
				}
			}
			modifier = {
				factor = 0.1 # Already obedient
				FROM = {
					is_society_grandmaster = yes
				}
				society_member_of = hwarang
			}
			modifier = {
				factor = 0
				FROM = {
					is_antagonizing = ROOT # TODO: Fix
				}
			}
			modifier = {
				factor = 0
				FROM = {
					any_rival = {
						character = ROOT
					}
				}
			}
		}
	}
	
	hwarang_reflect_on_traits = {
		ai_check_interval = 12
		is_in_society = yes
		filter = self
		ai_target_filter = self
		from_potential = {
			society_member_of = hwarang
			society_rank >= 2
		}
		
		potential = {
			character = FROM
		}
		
		allow = {
			is_inaccessible_or_incapable_trigger = no
			has_society_currency_medium_trigger = yes
		}
		
		effect = {
			detract_society_currency_medium_effect = yes
			
			# TODO: Self-reflection
		}
		
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.5
				trait = content
			}
			modifier = {
				factor = 5
				trait = humble
			}
			modifier = {
				factor = 0.2
				trait = proud
			}
			modifier = {
				factor = 5
				trait = diligent
			}
			modifier = {
				factor = 0.1
				trait = slothful
			}
			modifier = {
				factor = 0.01
				trait = depressed
			}
			modifier = {
				factor = 0.1
				NOT = {
					has_quest = quest_hwarang_self_reflection
				}
			}
			modifier = {
				factor = 0.1
				NOT = {
					has_society_currency_major_trigger = yes
				}
			}
			modifier = {
				factor = 0.1
				trait = cynical
			}
			modifier = {
				factor = 10
				trait = zealous
			}
			modifier = {
				factor = 10
				OR = {
					has_ambition = obj_buddhist_stop_drinking
					has_ambition = obj_buddhist_reject_empty_pleasures
					has_ambition = obj_buddhist_abstain_sexual_excess
					has_ambition = obj_buddhist_reject_cruelty
					has_ambition = obj_buddhist_temperance_food
					has_ambition = obj_buddhist_reject_greed
					has_ambition = obj_buddhist_reject_envy
					has_ambition = obj_buddhist_reject_hate
					has_ambition = obj_buddhist_reject_pride
					has_ambition = obj_buddhist_defeat_fear
					has_ambition = obj_become_paragon_of_enlightenment
				}
			}
		}
	}
	
	hwarang_nap = {
		ai_check_interval = 12
		ai_target_filter = realm
		ai_target_filter = society
		filter = realm
		filter = society
		from_potential = {
			society_member_of = hwarang
			society_rank >= 3
		}
		potential = {
			OR = {
				AND = {
					liege = {
						character = FROM
					}
					OR = {
						FROM = {
							ai = no
						}
						higher_tier_than = baron
						is_patrician = yes
					}
				}
				AND = {
					society_member_of = hwarang
					is_landed = yes
				}
			}
		}
		allow = {
			is_inaccessible_or_incapable_trigger = no
			is_adult = yes
			FROM = {
				is_inaccessible_or_incapable_trigger = no
				is_adult = yes
			}
			NOR = {
				has_opinion_modifier = {
					who = FROM
					modifier = opinion_hwarang_i_refused_nap
				}
				has_opinion_modifier = {
					who = FROM
					modifier = opinion_hwarang_refused_nap
				}
				has_non_aggression_pact_with = FROM
			}
			OR = {
				AND = {
					tier = count
					FROM = {
						has_society_currency_minor_trigger = yes
					}
				}
				AND = {
					tier = duke
					controls_religion = no
					FROM = {
						has_society_currency_medium_trigger = yes
					}
				}
				AND = {
					OR = {
						tier = emperor
						tier = king
						controls_religion = yes
					}
					FROM = {
						has_society_currency_major_trigger = yes
					}
				}
			}
		}
		effect = {
			if = {
				limit = {
					tier = count
				}
				FROM = {
					detract_society_currency_minor_effect = yes
				}
			}
			else_if = {
				limit = {
					tier = duke
					controls_religion = no
				}
				FROM = {
					detract_society_currency_medium_effect = yes
				}
			}
			else = {
				FROM = {
					detract_society_currency_major_effect = yes
				}
			}
			# TODO: Send an event to the other party, offering the NAP
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0 # Wasteful
				NOR = {
					AND = {
						independent = yes
						FROM = {
							independent = yes
						}
					}
					liege = {
						character = FROM
					}
					same_realm = FROM
				}
			}
			modifier = {
				factor = 0 # Wasteful
				liege = {
					character = FROM
				}
				opinion = {
					who = FROM
					value = 50
				}
				in_faction = no
				OR = {
					is_voter = no
					has_position = loyalist
				}
			}
			modifier = {
				factor = 10
				liege = {
					character = FROM
				}
				in_faction = yes
			}
			modifier = {
				factor = 10
				liege = {
					character = FROM
				}
				is_voter = yes
				has_position = malcontent
			}
			modifier = {
				factor = 0.1
				FROM = {
					trait = trusting
				}
			}
			modifier = {
				factor = 0.1
				FROM = {
					is_dumb_trigger = yes
				}
			}
			modifier = {
				factor = 0.1 # Already obedient
				FROM = {
					is_society_grandmaster = yes
				}
				society_member_of = hwarang
			}
			modifier = {
				factor = 0
				FROM = {
					is_antagonizing = ROOT # TODO: Fix
				}
			}
			modifier = {
				factor = 0
				FROM = {
					any_rival = {
						character = ROOT
					}
				}
			}
		}
	}
}

title_decisions = {
	hwarang_organize_patrols = {
		ai_check_interval = 60
		potential = {
			tier = count
			holder_scope = {
				OR = {
					character = FROM
					any_liege = {
						character = FROM
					}
				}
			}
		}
		from_potential = {
			society_member_of = hwarang
			society_rank >= 2
		}
		allow = {
			location = {
				revolt_risk >= 0.01 # Wasteful if not
			}
			FROM = {
				is_inaccessible_or_incapable_trigger = no
				has_society_currency_medium_trigger = yes
			}
		}
		effect = {
			FROM = {
				detract_society_currency_medium_effect = yes
			}
			# TODO: Apply a modifier on the province that lowers revolt risk
		}
		ai_will_do = {
			factor = 1
			modifier = {
				factor = 0.01
				always = yes # Slow it down!
			}
			modifier = {
				factor = 0.1
				NOT = {
					holder_scope = {
						character = FROM
					}
				}
			}
			modifier = {
				factor = 0.1
				location = {
					NOT = {
						revolt_risk >= 0.02
					}
				}
			}
			modifier = {
				factor = 10
				location = {
					revolt_risk >= 0.1
				}
			}
		}
	}
}